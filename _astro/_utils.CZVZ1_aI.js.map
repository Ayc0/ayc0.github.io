{"version":3,"file":"_utils.CZVZ1_aI.js","sources":["../../src/components/experiments/page-react-extension/stack/_utils.ts"],"sourcesContent":["import { getDisplayName } from \"bippy\";\nimport * as React from \"react\";\n\n// Copied from https://github.com/facebook/react/blob/da996a15be4f14aeb9726037f4559ff1cb3c2600/packages/shared/DefaultPrepareStackTraceV8.js\n// function DefaultPrepareStackTrace(\n//   error: Error,\n//   structuredStackTrace: any[],\n// ): string {\n//   const name = error.name || \"Error\";\n//   const message = error.message || \"\";\n//   let stack = name + \": \" + message;\n//   for (let i = 0; i < structuredStackTrace.length; i++) {\n//     stack += \"\\n    at \" + structuredStackTrace[i].toString();\n//   }\n//   return stack;\n// }\n\n// Doesn't work for debugging errors\n// But works for the React devtools & for some minified logs:\n// - CustomPragma ✅\n// - Foo ❌ (says O.render, not Foo.render)\n// - Bar ❌ (says \"\", not BarInternal nor Bar)\nexport function setName(_obj: any, _name: string) {\n  // Disable for now, to see how RUM works here\n  // Object.defineProperty(obj, \"name\", {\n  //   writable: false,\n  //   enumerable: false,\n  //   configurable: true,\n  //   value: name,\n  // });\n}\n\n// Inspired from https://github.com/facebook/react/blob/4a9df08157f001c01b078d259748512211233dcf/packages/shared/ReactOwnerStackFrames.js#L12 but swapped `react-stack-top-frame` with `========`\nexport function formatStack(error: Error): string {\n  // const prevPrepareStackTrace = Error.prepareStackTrace;\n  // Error.prepareStackTrace = DefaultPrepareStackTrace;\n  let stack = error.stack!;\n  // Error.prepareStackTrace = prevPrepareStackTrace;\n  if (stack.startsWith(\"Error: ========\\n\")) {\n    // V8's default formatting prefixes with the error message which we\n    // don't want/need.\n    stack = stack.slice(\"Error: ========\\n\".length);\n  }\n  let idx = stack.indexOf(\"\\n\");\n  if (idx !== -1) {\n    // Pop the h frame.\n    // For Chrome & FF\n    stack = stack.slice(idx + 1);\n    // We could use `Error.captureStackTrace(debugStack, h)` in the h function, but it doesn't work in Firefox and older browsers\n  }\n\n  // Only keep 1 line:\n  idx = stack.indexOf(\"\\n\");\n  if (idx !== -1) {\n    // Pop the h frame.\n    // For Chrome & FF\n    stack = stack.slice(0, idx + 1);\n  }\n\n  // react-stack-bottom-frame only exists in __DEV__, so can't be used for prod build\n  idx = stack.indexOf(\"react-stack-bottom-frame\");\n  if (idx === 0) {\n    return \"\";\n  }\n  if (idx !== -1) {\n    idx = stack.lastIndexOf(\"\\n\", idx);\n  }\n  if (idx !== -1) {\n    // Cut off everything after the bottom frame since it'll be internals.\n    stack = stack.slice(0, idx);\n  } else {\n    // We didn't find any internal callsite out to user space.\n    // This means that this was called outside an owner or the owner is fully internal.\n    // To keep things light we exclude the entire trace in this case.\n    // Difference from copied code: I commented this out to keep the full stack\n    // return \"\";\n  }\n  return stack;\n}\n\n// Every JSX created is mapped to unique objects. So we can identify every render of every JSX with the props\n// And even when we do `<div />` or `React.createElement('div')`, or `React.createElement('div', null)`, React uses `{}` in the end for the created props\n// See https://github.com/facebook/react/blob/ef4bc8b4f91023afac437be9179beef350b32db3/packages/react/src/jsx/ReactJSXElement.js#L658-L659\n// The only one I noticed that was `null` here was the root of the app, which we frankly don't care about\nconst MAPPED_PROPS = new WeakMap<any, Error>();\nconst conflictProps = new WeakSet<any>();\n\n// @ts-expect-error\nexport const h: typeof React.createElement = (type, ...args) => {\n  // Note: those don't work nicely:\n  // - with class in Firefox: only display `render`, not `ComponentName.render`\n  // - in Safari: only `h` appears, not the component render\n  const debugStack = new Error(\"========\");\n\n  // When converting ReactElement to Fiber, only the type & the props are passed, so we can only play with those 2\n  // See https://github.com/facebook/react/blob/da996a15be4f14aeb9726037f4559ff1cb3c2600/packages/react-reconciler/src/ReactFiber.js#L746-L756 or https://github.com/facebook/react/blob/da996a15be4f14aeb9726037f4559ff1cb3c2600/packages/react-reconciler/src/ReactFiber.js#L546\n\n  if (typeof type === \"function\") {\n    // We could want to bind to have a location per render, but realistically those don't change\n    const cloned = type;\n\n    // const cloned = type.bind();\n\n    // const name = type.displayName || type.name;\n    // setName(cloned, name);\n\n    type = cloned;\n    // console.log(\"[CUSTOM] function\", debugStack.stack?.split(\"\\n\"));\n  } else if (type && typeof type === \"object\" && \"$$typeof\" in type) {\n    if (type.$$typeof === Symbol.for(\"react.memo\")) {\n      // MAPPED_TYPES.set(type.type, debugStack); // Set for fiber.type\n\n      // For Object.memo, often we use them with anonymous functions, like React.memo(() => <div />)\n      // But this generates \"\" for the name for the stack traces\n      if (\n        !type.type.name &&\n        (getDisplayName(type.type) || getDisplayName(type))\n      ) {\n        setName(\n          type.type,\n          getDisplayName(type.type) || \"memo(\" + getDisplayName(type) + \")\",\n        );\n      }\n    } else {\n      console.log(\"[CUSTOM] OTHER TYPE\", type, {\n        debugStack,\n        owner: formatStack(debugStack),\n      });\n    }\n  } else if (typeof type === \"string\") {\n    // Do nothing\n  } else {\n    console.log(\"[CUSTOM] OTHER TYPE\", type, {\n      debugStack,\n      owner: formatStack(debugStack),\n    });\n  }\n\n  // if (type && typeof type === \"object\") {\n  // TODO: handle `memo` & `forwardRef` (& `lazy`?)\n  // }\n\n  // Re-enable this comment to see the full pretty error when the React devtools are installed\n  // console.error(\"HA\");\n  // console.log(\"[CUSTOM] stack\", {\n  //   raw: debugStack.stack.split(\"\\n\"),\n  //   formatted: formatStack(debugStack),\n  // });\n\n  const element = React.createElement(type, ...args);\n  // mapType.set(element, debugStack);\n\n  if (element.props) {\n    if (MAPPED_PROPS.has(element.props)) {\n      console.warn(\n        \"[CUSTOM][PROPS] THIS SHOULD NOT EXIST: CONFLICT ON \",\n        element.props,\n        element,\n      );\n      MAPPED_PROPS.delete(element.props);\n      conflictProps.add(element.props);\n    }\n    if (!conflictProps.has(element.props)) {\n      MAPPED_PROPS.set(element.props, debugStack);\n    }\n  }\n\n  return element;\n};\n\n// @ts-expect-error\nwindow._DEBUG_MAPPED_PROPS = MAPPED_PROPS;\n"],"names":["formatStack","error","stack","idx","MAPPED_PROPS","conflictProps","h","type","args","debugStack","getDisplayName","element","React.createElement"],"mappings":"yFAiCO,SAASA,EAAYC,EAAsB,CAGhD,IAAIC,EAAQD,EAAM,MAEdC,EAAM,WAAW;AAAA,CAAmB,IAG9BA,EAAAA,EAAM,MAAM,EAA0B,GAE5C,IAAAC,EAAMD,EAAM,QAAQ;AAAA,CAAI,EAkB5B,OAjBIC,IAAQ,KAGFD,EAAAA,EAAM,MAAMC,EAAM,CAAC,GAKvBA,EAAAD,EAAM,QAAQ;AAAA,CAAI,EACpBC,IAAQ,KAGVD,EAAQA,EAAM,MAAM,EAAGC,EAAM,CAAC,GAI1BA,EAAAD,EAAM,QAAQ,0BAA0B,EAC1CC,IAAQ,EACH,IAELA,IAAQ,KACJA,EAAAD,EAAM,YAAY;AAAA,EAAMC,CAAG,GAE/BA,IAAQ,KAEFD,EAAAA,EAAM,MAAM,EAAGC,CAAG,GAQrBD,EACT,CAMA,MAAME,MAAmB,QACnBC,MAAoB,QAGbC,EAAgC,CAACC,KAASC,IAAS,CAIxD,MAAAC,EAAa,IAAI,MAAM,UAAU,EAKnC,OAAOF,GAAS,WASXA,EAPQA,EASNA,GAAQ,OAAOA,GAAS,UAAY,aAAcA,EACvDA,EAAK,WAAa,OAAO,IAAI,YAAY,EAMzC,CAACA,EAAK,KAAK,OACVG,EAAeH,EAAK,IAAI,GAAKG,EAAeH,CAAI,KAG/CA,EAAK,KACLG,EAAeH,EAAK,IAAI,GAAK,GAAUG,EAAeH,CAAI,EAF5D,QAMM,QAAA,IAAI,sBAAuBA,EAAM,CACvC,WAAAE,EACA,MAAOT,EAAYS,CAAU,CAAA,CAC9B,EAEM,OAAOF,GAAS,UAGjB,QAAA,IAAI,sBAAuBA,EAAM,CACvC,WAAAE,EACA,MAAOT,EAAYS,CAAU,CAAA,CAC9B,EAcH,MAAME,EAAUC,EAAAA,cAAoBL,EAAM,GAAGC,CAAI,EAGjD,OAAIG,EAAQ,QACNP,EAAa,IAAIO,EAAQ,KAAK,IACxB,QAAA,KACN,sDACAA,EAAQ,MACRA,CACF,EACaP,EAAA,OAAOO,EAAQ,KAAK,EACnBN,EAAA,IAAIM,EAAQ,KAAK,GAE5BN,EAAc,IAAIM,EAAQ,KAAK,GACrBP,EAAA,IAAIO,EAAQ,MAAOF,CAAU,GAIvCE,CACT,EAGA,OAAO,oBAAsBP"}