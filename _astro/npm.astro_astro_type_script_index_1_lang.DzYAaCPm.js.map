{"version":3,"file":"npm.astro_astro_type_script_index_1_lang.DzYAaCPm.js","sources":["../../src/components/experiments/page-react-extension/npm/App.tsx","../../src/components/experiments/page-react-extension/npm/index.tsx"],"sourcesContent":["import * as React from \"react\";\n// import { getFiberStack, getDisplayName, type Fiber } from \"bippy\";\nimport { getFiberData, getFiberFromElement } from \"../fiber\";\nimport { getErrorStackFromInfo } from \"../error\";\n\nclass ErrorBoundary extends React.Component<\n  React.PropsWithChildren<{ fallback?: React.ReactNode }>,\n  { hasError: boolean }\n> {\n  constructor(props: React.PropsWithChildren<{ fallback?: React.ReactNode }>) {\n    super(props);\n    this.state = { hasError: false };\n  }\n\n  static displayName = \"ErrorBoundary\";\n\n  static getDerivedStateFromError(_error: Error) {\n    // Update state so the next render will show the fallback UI.\n    return { hasError: true };\n  }\n\n  override componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {\n    console.log(\"[CUSTOM] componentDidCatch\", {\n      errorStack: getErrorStackFromInfo(errorInfo),\n      error,\n    });\n  }\n\n  override render() {\n    if (this.state.hasError) {\n      return this.props.fallback || null;\n    }\n\n    return (\n      <fieldset style={{ display: \"inline\", border: \"1px solid red\" }}>\n        <legend>Error Boundary</legend>\n        {this.props.children}\n      </fieldset>\n    );\n  }\n}\n\nconst ErrorThrowerOnClick = () => {\n  return (\n    <button\n      onClick={() => {\n        throw new Error(\"Hello\");\n      }}\n    >\n      Trigger ðŸ’¥ crash (in onClick)\n    </button>\n  );\n};\nErrorThrowerOnClick.displayName = \"ErrorThrowerOnClick\";\n\nfunction ErrorThrowerOnRender() {\n  const [aaaa, setAaaa] = React.useState(false);\n  if (aaaa) {\n    throw new Error(\"Hello\");\n  }\n  return (\n    <button\n      onClick={() => {\n        setAaaa(true);\n      }}\n    >\n      Trigger ðŸ’¥ crash (on render)\n    </button>\n  );\n}\nErrorThrowerOnRender.displayName = \"ErrorThrowerOnRender\";\n\nconst ErrorThrowerOnEffect = () => {\n  const [aaaa, setAaaa] = React.useState(false);\n\n  React.useEffect(() => {\n    if (aaaa) {\n      throw new Error(\"Hello\");\n    }\n  }, [aaaa]);\n\n  return (\n    <button\n      onClick={() => {\n        setAaaa(true);\n      }}\n    >\n      Trigger ðŸ’¥ crash (on effect)\n    </button>\n  );\n};\nErrorThrowerOnEffect.displayName = \"ErrorThrowerOnEffect\";\n\nconst ClickTracker = ({ children }: { children?: React.ReactNode }) => {\n  return (\n    <fieldset\n      style={{ display: \"inline\", border: \"1px dashed blue\" }}\n      onClick={(event) => {\n        const fiber = getFiberFromElement(event.target);\n        if (!fiber) {\n          return;\n        }\n        const fiberData = getFiberData(fiber);\n        console.log(\"[CUSTOM] Clicked on\", {\n          element: event.target,\n          fiber: fiber,\n          ...fiberData,\n        });\n      }}\n    >\n      <legend>Click Tracker</legend>\n      {children}\n    </fieldset>\n  );\n};\nClickTracker.displayName = \"ClickTracker\";\n\nconst Bar = () => {\n  return (\n    <ClickTracker>\n      <ErrorThrowerOnClick />\n      <ErrorThrowerOnRender />\n      <ErrorThrowerOnEffect />\n\n      <ErrorBoundary>\n        <ErrorThrowerOnClick />\n        <ErrorThrowerOnRender />\n        <ErrorThrowerOnEffect />\n      </ErrorBoundary>\n    </ClickTracker>\n  );\n};\nBar.displayName = \"Bar\";\n\nconst Foo = () => {\n  return <Bar />;\n};\nFoo.displayName = \"Foo\";\n\nexport const App = () => {\n  return (\n    <>\n      <div>Hello World</div>\n      <Foo />\n    </>\n  );\n};\nApp.displayName = \"App\";\n","// import { instrument, secure } from \"bippy\"; // must be imported BEFORE react\nimport * as React from \"react\";\nimport { createRoot } from \"react-dom/client\";\n\nimport { App } from \"./App\";\nimport type { Fiber } from \"bippy\";\n// import { getMutatedHostFibers, instrument, secure, type Fiber } from \"bippy\";\nimport { getFiberData /* , getRoot */ } from \"../fiber\";\nimport { getErrorStackFromInfo } from \"../error\";\n\n// instrument(\n//   secure({\n//     onCommitFiberRoot(rendererID, root) {\n//       console.log(\"root ready to commit\", rendererID, root);\n//       console.log(getMutatedHostFibers(root.current));\n//     },\n//     onPostCommitFiberRoot(rendererID, root) {\n//       console.log(\"root with effects committed\", rendererID, root);\n//     },\n//     onCommitFiberUnmount(rendererID, fiber) {\n//       console.log(\"fiber unmounted\", rendererID, fiber);\n//     },\n//   }),\n// );\n\nconst button = document.getElementById(\"button\") as HTMLButtonElement;\n\nbutton.addEventListener(\"click\", () => {\n  createRoot(document.getElementById(`node`)!, {\n    onCaughtError(_error, errorInfo) {\n      // @ts-expect-error\n      const fiber = errorInfo.errorBoundary?._reactInternals as\n        | Fiber\n        | undefined;\n\n      // TODO: even with displayName, getErrorStackFromInfo(errorInfo) can use the minified version. Why may want to go through the fiber manually to match the error stack, or via source maps\n      console.log(\"[CUSTOM] Error caught by Error Boundary\", {\n        boundaryStack: fiber ? getFiberData(fiber).fiberStack : null,\n        errorStack: getErrorStackFromInfo(errorInfo),\n      });\n\n      // console.log(\"onCaughtError\", {\n      // error,\n      // errorInfo,\n      // fiber,\n      // // mutated: getMutatedHostFibers(fiber),\n      // root: getRoot(fiber),\n      // updatedNode: getRoot(fiber)\n      //   .pendingUpdatersLaneMap.flatMap((lane) => [...lane])\n      //   .map(getFiberData),\n      // mutatedRoot: getMutatedHostFibers(getRoot(fiber)),\n      // fiberData: getFiberData(fiber),\n      // returnData: getFiberData(fiber.return),\n      // });\n      // console.dir(error);\n      // console.dir(errorInfo);\n    },\n\n    onUncaughtError(error, errorInfo) {\n      // console.log(\"onUncaughtError\", { error, errorInfo });\n      console.log(\"[CUSTOM] Error not caught by Error Boundary\", {\n        errorStack: getErrorStackFromInfo(errorInfo),\n        error,\n      });\n    },\n\n    onRecoverableError(error, errorInfo) {\n      console.log(\"[CUSTOM] Recoverable error\", {\n        errorStack: getErrorStackFromInfo(errorInfo),\n        error,\n      });\n    },\n  }).render(<App />);\n  button.disabled = true;\n});\n"],"names":["ErrorBoundary","React.Component","props","_error","error","errorInfo","getErrorStackFromInfo","jsxs","jsx","ErrorThrowerOnClick","ErrorThrowerOnRender","aaaa","setAaaa","React.useState","ErrorThrowerOnEffect","React.useEffect","ClickTracker","children","event","fiber","getFiberFromElement","fiberData","getFiberData","Bar","Foo","App","Fragment","button","createRoot"],"mappings":"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"}